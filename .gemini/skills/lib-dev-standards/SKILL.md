---
name: lib-dev-standards
description: 競技プログラミング用 Rust ライブラリ開発の設計指針（抽象代数的設計、構造的対称性、スニペットの依存分離、コーディング規約）を適用する。
---

# Library Development Standards

高品質で汎用性が高く、メンテナンスしやすい Rust ライブラリを構築するための設計思想と指針。この文書は、新たな知見が得られるたびに更新・進化し続けるものである。

## 1. 抽象代数的アプローチによる設計 (Abstract Algebraic Design)
特定の型（`i64` 等）やそのドメイン（定義域）への依存を排除し、計算に本質的に必要な「代数的性質」のみを要求する。

- **ドメイン依存からの脱却**: `From<i64>` を避ける本質的な理由は、型 `T` が「整数そのもの」であるという強い仮定を排除することにある。
- **「変換」から「作用・系内部の演算」への転換**:
    - **スカラー倍の作用 (`Mul<i64>`)**: 整数 $n$ を `T` に「変換」して掛けるのではなく、`T` に対して整数 $n$ が「作用（スカラー倍）」できることを要求する。
    - **系内部での単位元生成 (`Sum`)**: `0.into()` ではなく、代数系が持つ演算ルール（`Sum` 等）から単位元を導き出す。
- **インターフェースの純粋化**: 型の「ドメイン」ではなく「能力」に基づいてトレイト境界を定義する。

## 2. 構造的対称性の維持 (Structural Symmetry)
対になる概念（最小/最大など）を扱うファイル群は、ミラー構造を維持する。

- **クローン構造の追求**: 行数、空行の位置、インポートの順序、メソッドの定義順を完全に一致させる。
- **メンテナンス性の同期**: `symmetry-syncer` スキルを用い、スタイル上のノイズを徹底的に排除する。

## 3. スニペットの依存分離 (Dependency-Aware Snippet Design)
`cargo-snippet` で展開されるコードの依存グラフを最小限に保つ。

- **コア実装の隔離**: ベースとなるスニペットには、その機能に本質的に必要な依存のみを含める。
- **拡張機能の外出し**: 特定の外部トレイト実装などは別スニペットとして定義し、コアへの依存を増やさない。
- **統合テストの配置**: 原則として「依存する側」のファイルにテストを記述し、コア側に不要な依存が混入するのを防ぐ。

## 4. コーディング規約 (Coding Conventions)

### 4.1. `rand` クレートの利用
- **バージョン**: `0.9.2` を使用。
- **メソッド**: `rng.random_range` を使用（`gen_range` は不可）。
- **初期化**: `from_os_rng` を使用（`from_entropy` は不可）。

### 4.2. ランダムテスト
- ランダムテストを実装する際には必ず `#[ignore]` 属性を付与すること。
- 実装の詳細は [random-testing.md](references/random-testing.md) を参照。

### 4.3. コメント
- **既存のコードを編集、または既存のコードから新しいコードを作るとき、既存のコードのコメントを消してはいけません。**
- 日本語で記述する。
- 「何をしているか (What)」ではなく、コードが存在する「なぜ (Why)」やロジックの「要点」を説明する。
- コードから直接読み取れる自明なコメント（ノイズ）は書かない。
- 「ここを変更」のような将来的に不要になる一時的なコメントは避ける。

### 4.4. コーディングスタイル
- できるだけ手続き的ではなく宣言的なコードを書く。
- `mutable` な変数よりも `immutable` な変数を優先する。ただし、可読性や計算量の観点で手続き的・`mutable` な実装が勝る場合はその限りではない。

### 4.5. モジュール内のインポート (`cargo-snippet` 対策)
- `pub mod` の内部で `crate::...` を使ってインポートしない。
- ファイルの先頭（`pub mod` の外）で `crate::...` を使ってインポートし、モジュール内では `super::...` を使って参照する。

## 5. シンボル名変更時の整合性維持 (Naming Consistency)
リファクタリングにより型、関数、定数などのシンボル名を変更した際は、ドキュメントコメントやテスト関数名も一貫性を持って同期させる。

## 6. 代数演算子の設計指針 (Algebraic Operator Design)
- **無限大と 0 の乗算**: Z-加群としての作用を模す場合、原則として $ \infty \times 0 = 0 $ と定義する（「無限大を 0 回足した結果は単位元である」という解釈）。
- **ドメイン外の入力とパニック**: 演算の引数が前提を外れる場合は、妥協して結果を返すのではなく、速やかに `panic!` させる。

## 7. 指針の継続的改善 (Continuous Improvement)
- 知見が得られるたびに本スキルを更新し、設計品質を底上げする。